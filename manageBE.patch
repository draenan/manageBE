--- manageBE	2012-04-17 14:18:38.000000000 +1000
+++ manageBE.new	2012-06-15 00:45:10.852605254 +1000
@@ -2,8 +2,13 @@
 #
 # $Id: manageBE.patch,v 1.1 2012/06/19 05:08:39 awaters Exp $
 #
-
 # manageBE [activate|create|delete|list|src-upgrade|freebsd-update|freebsd-upgrade] {params}
+#
+# Original code by cryx: http://anonsvn.h3q.com/projects/freebsd-patches/browser/manageBE
+#
+# Modified to fix broken actions and implement filesystem property inheritance. Also to 
+# change boot-environment user property name.
+#
 
 if [ `uname -r |cut -d '.' -f1` -lt "8" ]; then
     echo "Sorry, only FreeBSD starting with 8.0 is supported."
@@ -26,13 +31,25 @@
 exerr () { echo -e "$*" >&2 ; exit 1; }
 
 check_for_be_existence () {
-    be_status=`/sbin/zfs list -H -o freebsd:boot-environment ${pool}/ROOT/${bootfs} 2> /dev/null` 
+    be_status=`/sbin/zfs list -H -o org.freebsd:boot-environment ${pool}/ROOT/${bootfs} 2> /dev/null` 
     if [ "${be_status}" != "1" ]; then
-        echo "Sorry, ${bootfs} is no valid boot-environment"
+        echo "Sorry, ${bootfs} is not a valid boot environment."
         exit
     fi
 }
 
+
+# Ensures properties are replicated for filesystems in newly cloned bootfs.
+set_props () {
+    for prop in `/sbin/zfs get -H -o property -s local all $1`; do
+        echo $prop | /usr/bin/grep 'org.freebsd:boot-environment' >/dev/null 2>&1
+        if [ "$?" -eq "1" ]; then
+            value=`/sbin/zfs get -H -o value $prop $1`
+            /sbin/zfs set $prop=$value $2
+        fi
+    done
+}
+
 case ${type} in
     activate)
         # activate a boot-environment
@@ -65,7 +82,7 @@
         esac; done; shift $(( ${OPTIND} - 1 ))
 
         [ "${new_bootfs}" -a "${pool}" ] || exerr ${usage_create}
-        
+
         if [ -z "${bootfs}" ]; then
             bootfs=`/sbin/zpool list -H -o bootfs ${pool} | /usr/bin/sed s:${pool}/ROOT/::`
         fi
@@ -76,23 +93,32 @@
         /sbin/zfs snapshot -r ${pool}/ROOT/${bootfs}@${new_bootfs}
         /sbin/zfs clone ${pool}/ROOT/${bootfs}@${new_bootfs} ${pool}/ROOT/${new_bootfs}
 
+        # ensure filesystem properties of parent are inherited.
+        set_props ${pool}/ROOT/${bootfs} ${pool}/ROOT/${new_bootfs}
+
         # clone the children snapshot to create the new BE children, mark the filesystem as not being BEs
         for filesystem in `/sbin/zfs list -H -o name -t filesystem -r ${pool}/ROOT/${bootfs} | /usr/bin/sed s:${pool}/ROOT/${bootfs}:: | /usr/bin/sed s:^/:: | /usr/bin/xargs`; do
           /sbin/zfs clone ${pool}/ROOT/${bootfs}/${filesystem}@${new_bootfs} ${pool}/ROOT/${new_bootfs}/${filesystem}
-          /sbin/zfs set freebsd:boot-environment=0 ${pool}/ROOT/${new_bootfs}/${filesystem}
+          set_props ${pool}/ROOT/${bootfs}/${filesystem} ${pool}/ROOT/${new_bootfs}/${filesystem}
+          /sbin/zfs set org.freebsd:boot-environment=0 ${pool}/ROOT/${new_bootfs}/${filesystem}
         done
 
         # mark the BE as boot-environment and mount the freebsd-update dir in the correct path
-        /sbin/zfs set freebsd:boot-environment=1 ${pool}/ROOT/${new_bootfs}
+        /sbin/zfs set org.freebsd:boot-environment=1 ${pool}/ROOT/${new_bootfs}
 
         grep -v '^vfs.root.mountfrom' /boot/loader.conf > /${pool}/ROOT/${new_bootfs}/boot/loader.conf
         echo vfs.root.mountfrom=\"zfs:${pool}/ROOT/${new_bootfs}\" >> /${pool}/ROOT/${new_bootfs}/boot/loader.conf
-        
+
         # fill the fstab with the mounts of the BE children
         grep -v ${pool}/ROOT/${bootfs} /etc/fstab > /${pool}/ROOT/${new_bootfs}/etc/fstab
         echo "# Automatically generated by manageBE (${pool}/ROOT/${new_bootfs})" >> /${pool}/ROOT/${new_bootfs}/etc/fstab
         for filesystem in `/sbin/zfs list -H -o name -t filesystem -r ${pool}/ROOT/${new_bootfs} | /usr/bin/sed s:${pool}/ROOT/${new_bootfs}:: | /usr/bin/sed s:^/:: | /usr/bin/xargs`; do
-          echo "${pool}/ROOT/${new_bootfs}/${filesystem} /${filesystem} zfs rw 0 0" >> /${pool}/ROOT/${new_bootfs}/etc/fstab
+          /sbin/zfs get -H -o value readonly ${pool}/ROOT/${new_bootfs}/$filesystem | grep -q on
+          if [ "$?" -eq "1" ]; then
+            echo "${pool}/ROOT/${new_bootfs}/${filesystem} /${filesystem} zfs rw 0 0" >> /${pool}/ROOT/${new_bootfs}/etc/fstab
+          else
+            echo "${pool}/ROOT/${new_bootfs}/${filesystem} /${filesystem} zfs ro 0 0" >> /${pool}/ROOT/${new_bootfs}/etc/fstab
+          fi
         done
 
         echo "The new Boot-Environment is ready to be updated and/or activated."
@@ -161,12 +187,12 @@
 
         for be_filesystem in `/sbin/zfs list -H -S creation -o name -r $pool/ROOT |grep -v "^$pool/ROOT\$"`; do
 
-            if [ `/sbin/zfs list -H -o freebsd:boot-environment ${be_filesystem}` = 1 ]; then
+            if [ `/sbin/zfs list -H -o org.freebsd:boot-environment ${be_filesystem}` = 1 ]; then
                 be_name=`echo ${be_filesystem}|/usr/bin/sed s:^$pool/ROOT/::`
 
-                be_active='no'	
+                be_active='no'  
                 if [ "${be_filesystem}" = "${rootfs}" ]; then
-                    be_active='yes'	
+                    be_active='yes'     
                 fi
                 be_nextboot='no'
                 if [ "${be_filesystem}" = "${zpool_bootfs}" ]; then
@@ -223,25 +249,25 @@
 
         check_for_be_existence
 
-	mount -t nullfs -o ro /usr/src /${pool}/ROOT/${bootfs}/usr/src
-	mount -t nullfs -o ro /usr/obj /${pool}/ROOT/${bootfs}/usr/obj
+        mount -t nullfs -o ro /usr/src /${pool}/ROOT/${bootfs}/usr/src
+        mount -t nullfs -o ro /usr/obj /${pool}/ROOT/${bootfs}/usr/obj
 
-	echo '#!/bin/sh
+        echo '#!/bin/sh
 mount -t devfs devfs /dev
 cd /usr/src
 make -s installkernel && make -s installworld && /usr/sbin/mergemaster -U
 umount /dev' > /${pool}/ROOT/${bootfs}/tmp/manageBE-upgrade.sh
 
-	chmod +x /${pool}/ROOT/${bootfs}/tmp/manageBE-upgrade.sh
-	chroot /${pool}/ROOT/${bootfs}/ /tmp/manageBE-upgrade.sh
-	rm /${pool}/ROOT/${bootfs}/tmp/manageBE-upgrade.sh
-	umount /${pool}/ROOT/${bootfs}/usr/obj
-	umount /${pool}/ROOT/${bootfs}/usr/src
-	
-	echo "Please activate ${bootfs} via manageBE and reboot."
+        chmod +x /${pool}/ROOT/${bootfs}/tmp/manageBE-upgrade.sh
+        chroot /${pool}/ROOT/${bootfs}/ /tmp/manageBE-upgrade.sh
+        rm /${pool}/ROOT/${bootfs}/tmp/manageBE-upgrade.sh
+        umount /${pool}/ROOT/${bootfs}/usr/obj
+        umount /${pool}/ROOT/${bootfs}/usr/src
+
+        echo "Please activate ${bootfs} via manageBE and reboot."
     ;;
     freebsd-update)
-        [ `uname -r | cut -d '-' -f1,2` = "8.0-RELEASE" ] && exerr ${not_supported}
+        [ `uname -r | cut -d '-' -f2` == "RELEASE" ] || exerr ${not_supported}
         # update a boot-environment using freebsd-update
 
         shift; while getopts :n:p: arg; do case ${arg} in
@@ -250,19 +276,19 @@
             ?) exerr ${usage_freebsd_upgrade};;
         esac; done; shift $(( ${OPTIND} - 1 ))
 
-        [ "${bootfs}" -a "${pool}" -a ${release} ] || exerr ${usage_freebsd_update}
+        [ "${bootfs}" -a "${pool}" ] || exerr ${usage_freebsd_update}
 
         check_for_be_existence
-        
-        chroot /${bootfs} mount -t devfs devfs /dev
-        chroot /${bootfs} /usr/sbin/freebsd-update fetch
-        chroot /${bootfs} /usr/sbin/freebsd-update install > /dev/null
-        chroot /${bootfs} umount /dev
+
+        chroot /${pool}/ROOT/${bootfs} mount -t devfs devfs /dev
+        chroot /${pool}/ROOT/${bootfs} /usr/sbin/freebsd-update fetch
+        chroot /${pool}/ROOT/${bootfs} /usr/sbin/freebsd-update install > /dev/null
+        chroot /${pool}/ROOT/${bootfs} umount /dev
 
         echo "Please activate ${bootfs} via manageBE and reboot."
     ;;
     freebsd-upgrade)
-        [ `uname -r | cut -d '-' -f1,2` = "8.0-RELEASE" ] && exerr ${not_supported}
+        [ `uname -r | cut -d '-' -f2` == "RELEASE" ] || exerr ${not_supported}
         # upgrade a boot-environment using freebsd-update
 
         shift; while getopts :n:p:r: arg; do case ${arg} in
@@ -275,11 +301,11 @@
         [ "${bootfs}" -a "${pool}" -a ${release} ] || exerr ${usage_freebsd_upgrade}
 
         check_for_be_existence
-        
-        chroot /${bootfs} mount -t devfs devfs /dev
-        chroot /${bootfs} /usr/sbin/freebsd-update upgrade -r ${release}
-        chroot /${bootfs} /usr/sbin/freebsd-update install > /dev/null
-        chroot /${bootfs} umount /dev
+
+        chroot /${pool}/ROOT/${bootfs} mount -t devfs devfs /dev
+        chroot /${pool}/ROOT/${bootfs} /usr/sbin/freebsd-update upgrade -r ${release}
+        chroot /${pool}/ROOT/${bootfs} /usr/sbin/freebsd-update install > /dev/null
+        chroot /${pool}/ROOT/${bootfs} umount /dev
 
         echo "Please activate ${bootfs} via manageBE and reboot. After rebooting, freebsd-update needs to be run again to install the new userland components, and the system needs to be rebooted again"
     ;;
